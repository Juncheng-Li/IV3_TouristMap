<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Display driving directions</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet"/>
    <link href="style.css" rel="stylesheet">
</head>
<body>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
<link
        rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
        type="text/css"
/>
<div id="map"></div>
<div class="map-overlay" id="detailPanel">
    <button id="close-btn">x</button>
    <div id="detailTitle">
        <h3>This is</h3>
    </div>
    <div id="place">
        <img id = "placeImage" src="./images/poi/Melbourne%20Central.jpg" alt="poi">
    </div>

    <div>
        <p id="address">Address: 100 Swanston St, Melbourne 3000</p>
        <p id="openHour">Open hours: 10:00 - 18:00</p>
    </div>
    <div class="advanceInfo">
        <p class="infoButton ">
            <button class="filters" id="park-btn" style="background-image: url(./images/other/icons8-parking-96.png)"></button>
            <button class="filters" id="bike-btn" style="background-image: url(./images/other/bike.png)"></button>
            <button class="filters" id="ptv-btn" style="background-image: url(./images/other/ptv.jpeg)"></button>
        </p>
    </div>

</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoieXVubmluZ2ciLCJhIjoiY2tldjl0ZmZoMjRoajJxcXYzNGU1M2p0aCJ9.30fp6J7Abr9VbS_ev_jYpA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [144.96, -37.81],
        zoom: 14
    });
    var markerArr = [];

    var detailPanel = document.getElementById("detailPanel");
    detailPanel.hidden = true;


    var parkBtn = document.getElementById("park-btn");
    parkBtn.addEventListener('click', () => {
        console.log("park!!!");
    });
    var ptvBtn = document.getElementById("ptv-btn");
    ptvBtn.addEventListener('click', () => {
        console.log("ptv!!!");
    });
    var bikeBtn = document.getElementById("bike-btn");
    bikeBtn.addEventListener('click', () => {
        console.log("bike!!!");
    });
    var closeBtn = document.getElementById("close-btn");
    closeBtn.addEventListener('click', () => {
        // console.log("close!!!");
        detailPanel.hidden = true;
    });


    map.on('load', function () {
        const images = [
            {imageUrl: './images/icon/museum.png', id: 'museum'},
            {imageUrl: './images/icon/church.png', id: 'church'},
            {imageUrl: './images/icon/outdoor.png', id: 'outdoor'},
            {imageUrl: './images/icon/study.png', id: 'study'},
        ];
        images.forEach(img => {
            map.loadImage(img.imageUrl, function (error, res) {
                map.addImage(img.id, res)
            })
        });

        map.addSource('poiJSON', {
            'type': 'geojson',
            'data': 'datasets/Melbourne_POIs_MGA.geojson'
        });

        map.addSource('poi', {
            type: 'vector',
            url: 'mapbox://yunningg.d15riytj'
        });

        map.addLayer({
            id: 'icons',
            type: 'symbol',
            maxzoom: 15.9,
            source: 'poi',
            layout: {
                'visibility': 'visible',
                // 'icon-image': 'museum',
                'icon-image': {
                    property: 'Sub_Theme',
                    type: 'categorical',
                    stops: [
                        ['Art Gallery/Museum', 'museum'],
                        ['Church', 'church'],
                        ['Informal Outdoor Facility (Park/Garden/Reserve)', 'outdoor'],
                        ['Tertiary (University)', 'study'],
                    ]
                },
                'icon-size': 0.08,
                'icon-allow-overlap': true
            },
            'source-layer': 'Melbourne_POIs_MGA-0lenk4', // the name of your new point layer (see tileset)
        });


        //mark and popup
        map.on("sourcedata", function(e) {
            if (map.getSource('poi') && map.isSourceLoaded('poi')) {
                console.log('source loaded!');
                var features = map.querySourceFeatures('poi', {
                    sourceLayer: 'Melbourne_POIs_MGA-0lenk4'
                });
                features.forEach(x => {
                    if (x.properties.Theme !== "Transport") {
                        // popup
                        // var html = '<h4>' + x.properties.Feature_Na + '</h4>' +
                        //     '<img id=\"logo\" src=\'./images/poi/Melbourne%20Central.jpeg\'>';
                        // var popup = new mapboxgl.Popup({offset: 25}).setHTML(html);

                        // mark
                        var el = document.createElement('div');
                        var im = new Image();
                        // im.src = './images/poi/Melbourne Central.jpg';
                        im.src = './images/poi/' + x.properties.Feature_Na + '.jpg';
                        el.appendChild(im);
                        el.className = 'marker';
                        el.hidden = true;
                        el.id = x.properties.Feature_Na;
                        el.addEventListener('click', (e) => {
                            //set detail panel title
                            var detailTitle = document.getElementById("detailTitle");
                            detailTitle.innerHTML = '<h2>' + x.properties.Feature_Na + '</h2>';
                            //set detail panel image
                            var placeImg = document.getElementById("place");
                            placeImg.innerHTML = "<img id = \"placeImage\" src=\"./images/poi/" + x.properties.Feature_Na + ".jpg\" alt=\"poi\">";
                            detailPanel.hidden = false;
                        });
                        markerArr.push(el);
                        new mapboxgl.Marker(el)
                            .setLngLat(x.geometry.coordinates)
                            // .setPopup(popup)
                            .addTo(map);
                    }
                });
            }
        });
    });

    map.on('click', 'icons', function(e) {
        //set detail panel title
        var detailTitle = document.getElementById("detailTitle");
        detailTitle.innerHTML = '<h2>' + e.features[0].properties.Feature_Na + '</h2>';
        //set detail panel image
        var placeImg = document.getElementById("place");
        placeImg.innerHTML = "<img id = \"placeImage\" src=\"./images/poi/" + e.features[0].properties.Feature_Na + ".jpg\" alt=\"poi\">";
        detailPanel.hidden = false;
    });


    // map.addControl(
    //     new MapboxDirections({
    //         accessToken: mapboxgl.accessToken
    //     }),
    //     'top-left'
    // );

    map.on('zoom', function () {
        if (map.getZoom() <= 15.9) {
            markerArr.forEach(el => {
                el.hidden = true;
            });
        } else {
            markerArr.forEach(el => {
                el.hidden = false;
            });
        }
    });
</script>

</body>
</html>